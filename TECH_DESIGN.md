# M-Team PT App 技术设计文档

## 项目简介

### 背景

M-Team是一个知名的PT（Private Tracker）站点，提供高质量的影视资源分享服务。本项目是一个基于M-Team官方API的移动端应用，旨在为用户提供便捷的种子搜索和下载体验。

### 项目目标

- 提供简洁易用的种子搜索界面
- 支持高效的资源浏览和筛选
- 实现安全的API密钥管理
- 提供流畅的移动端用户体验

### 核心价值

- **便捷性**: 随时随地搜索和获取种子资源
- **安全性**: 本地加密存储用户凭证
- **高效性**: 智能缓存和无限滚动提升性能
- **专业性**: 针对PT用户需求定制的功能

## 功能概述

### 主要功能

1. **种子搜索**

   - 支持关键词模糊搜索
   - 分类筛选（电影、电视剧、音乐等）
   - 分页浏览和无限滚动
   - 搜索结果缓存

2. **资源详情**

   - 种子基本信息（名称、大小、评分）
   - 健康度指标（种子数、下载数）
   - 标签信息（画质、字幕、音轨等）
   - 优惠信息（免费、折扣等）

3. **下载管理**

   - 一键获取种子下载链接
   - 支持外部下载工具
   - 下载历史记录

4. **用户设置**
   - API密钥配置和验证
   - 应用主题切换
   - 搜索偏好设置

### 用户体验

- **首次使用**: 引导用户配置API密钥
- **日常使用**: 快速搜索 → 浏览结果 → 获取下载链接
- **个性化**: 记住用户偏好和搜索历史

## 技术架构

### 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   数据访问层     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 搜索界面      │    │ • 搜索管理      │    │ • API客户端     │
│ • 结果列表      │◄──►│ • 下载管理      │◄──►│ • 缓存管理      │
│ • 设置页面      │    │ • 配置管理      │    │ • 安全存储      │
│ • 主题系统      │    │ • 状态管理      │    │ • 数据模型      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### API设计

#### 1. 种子搜索接口

```typescript
// 请求
POST /api/torrent/search
Headers: {
  "x-api-key": "用户API密钥",
  "Content-Type": "application/json"
}
Body: {
  mode: "movie",           // 搜索模式
  visible: 1,              // 可见性
  keyword: "搜索关键词",    // 搜索关键词
  categories: [],          // 分类筛选
  pageNumber: 1,           // 页码
  pageSize: 20             // 页面大小
}

// 响应
{
  code: "0",               // 状态码：0=成功
  message: "SUCCESS",      // 响应消息
  data: {
    pageNumber: "1",       // 当前页码
    pageSize: "20",        // 页面大小
    total: "150",          // 总记录数
    totalPages: "8",       // 总页数
    data: [                // 种子列表
      {
        id: "1020011",
        name: "种子名称",
        size: "2147483648",  // 文件大小（字节）
        status: {
          seeders: "25",     // 种子数
          leechers: "5",     // 下载数
          discount: "PERCENT_50"  // 优惠类型
        },
        labelsNew: ["中字", "4K", "HDR10"],
        // ... 其他字段
      }
    ]
  }
}
```

#### 2. 下载链接接口

```typescript
// 请求
POST /api/torrent/genDlToken
Headers: {
  "x-api-key": "用户API密钥",
  "Content-Type": "application/x-www-form-urlencoded"
}
Body: "id=1020011"

// 响应
{
  code: "0",
  message: "SUCCESS",
  data: "https://api.m-team.cc/api/rss/dlv2?sign=xxx&t=xxx&tid=1020011&uid=xxx"
}
```

### 数据模型

#### 核心数据结构

```typescript
// 种子信息
interface Torrent {
  id: string; // 种子ID
  name: string; // 种子名称
  size: string; // 文件大小
  imdbRating: string; // IMDB评分
  doubanRating: string; // 豆瓣评分
  labelsNew: string[]; // 标签数组
  status: TorrentStatus; // 状态信息
}

// 种子状态
interface TorrentStatus {
  seeders: string; // 种子数
  leechers: string; // 下载数
  discount: string; // 优惠类型
  discountEndTime: string; // 优惠结束时间
}

// 搜索参数
interface SearchParams {
  mode: string; // 搜索模式
  keyword: string; // 关键词
  pageNumber: number; // 页码
  pageSize: number; // 页面大小
}
```

## 实现细节

### 关键业务流程

#### 1. 搜索流程

```
用户输入关键词 → 构建搜索参数 → 调用搜索API → 解析响应数据 → 更新UI显示
     ↓
检查缓存 → 命中缓存直接返回 / 未命中继续API调用 → 缓存新数据
```

#### 2. 下载流程

```
用户选择种子 → 获取种子ID → 调用下载API → 生成下载链接 → 调用外部下载器
```

#### 3. 配置流程

```
首次启动 → 检查API密钥 → 未配置显示设置页 → 用户输入密钥 → 验证并保存
```

### 性能优化策略

#### 1. 缓存策略

- **查询缓存**: 5分钟内相同搜索直接返回缓存
- **分页缓存**: 已加载页面数据保持在内存中
- **图片缓存**: 种子封面图片本地缓存

#### 2. 加载优化

- **无限滚动**: 自动加载下一页数据
- **骨架屏**: 加载过程显示占位符
- **懒加载**: 图片和非关键数据延迟加载

#### 3. 网络优化

- **请求重试**: 网络错误自动重试2次
- **超时控制**: 30秒请求超时
- **并发控制**: 限制同时进行的网络请求数量

### 安全机制

#### 1. 数据安全

- **API密钥加密**: 使用设备安全存储区
- **传输加密**: HTTPS协议保证传输安全
- **输入验证**: 防止恶意输入和XSS攻击

#### 2. 错误处理

- **网络异常**: 友好的错误提示和重试机制
- **API错误**: 根据错误码显示对应提示
- **崩溃保护**: 异常捕获防止应用崩溃
